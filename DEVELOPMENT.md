# PDF 보안 처리 시스템 개발 문서

## 1. 프로젝트 개요

**프로젝트명**: pdf_secure  
**목적**: 전자책 PDF 파일에 구매자 정보를 워터마크로 삽입하고 비밀번호를 설정하여 무단 배포를 방지하는 시스템

**핵심 가치**:
- 구매자별 고유 워터마크로 출처 추적 가능
- 비밀번호 보호로 무단 열람 방지
- 자동화된 일괄 처리로 작업 효율성 향상

---

## 2. 현재 구현된 기능

### 2.1 워터마크 삽입 기능

**기능 설명**:
- PDF 파일의 특정 페이지부터 구매자 정보를 워터마크로 삽입
- 워터마크는 "이 책은 {구매자명} ({연락처}) 님이 구매하신 전자책입니다." 형식

**구현 세부사항**:

1. **한글 폰트 처리 (크로스 플랫폼 지원)**
   - **Windows**: 맑은고딕(`C:/Windows/Fonts/malgun.ttf`) 또는 굴림(`gulim.ttc`) 자동 감지 및 등록
   - **macOS**: 애플고딕(`/System/Library/Fonts/AppleGothic.ttf`) 또는 나눔고딕 자동 감지 및 등록
   - 운영체제별로 여러 폰트 경로를 순차적으로 확인하여 사용 가능한 폰트를 찾음
   - 폰트 등록 실패 시: Helvetica 기본 폰트 사용 (한글 깨짐 주의)
   - `platform.system()`을 사용하여 운영체제 자동 감지

2. **워터마크 레이어 생성**
   - 메모리 내 가상 캔버스(BytesIO) 생성
   - A4 페이지 크기 기준으로 캔버스 설정
   - 폰트 크기: 10pt
   - 색상: RGB(0.5, 0.5, 0.5) - 밝은 회색
   - 투명도: 60% (Alpha 0.6)
   - 위치: 왼쪽 하단, x좌표 30, y좌표 45 (하단에서 글자 크기의 1.5배만큼 위로)

3. **페이지별 워터마크 적용**
   - 원본 PDF의 모든 페이지를 순회
   - 5번째 페이지(인덱스 4)부터 워터마크 적용
   - 앞의 4페이지(표지, 목차 등)에는 워터마크 미적용
   - 각 페이지에 워터마크 레이어를 병합(merge)하여 최종 페이지 생성

4. **파일 저장**
   - 처리된 모든 페이지를 새로운 PDF 파일로 저장
   - 파일명 형식: `{원본파일명}_{구매자명}.pdf`
   - 원본 파일과 같은 디렉토리에 저장

### 2.4 GUI 인터페이스

**기능 설명**:
- tkinter 기반 그래픽 사용자 인터페이스 제공
- 파일 선택, 정보 입력, 진행 상황 표시를 통합한 단일 창 인터페이스

**구현 세부사항**:

1. **파일 선택 다이얼로그**
   - `filedialog.askopenfilename()`을 사용하여 PDF 파일 선택
   - 선택된 파일 경로를 읽기 전용 Entry 위젯에 표시
   - 파일 유효성 검증 (존재 여부 확인)

2. **구매자 정보 입력 폼**
   - 이름 입력 필드
   - 연락처 입력 필드 (전화번호 또는 이메일)
   - PDF 비밀번호 입력 필드 (비밀번호가 그대로 표시됨)
   - 입력값 검증 (빈 값 체크)
   - 실시간 미리보기: 이름과 연락처 입력 시 워터마크 문구 미리보기 표시

3. **진행 상황 표시**
   - `ttk.Progressbar`를 사용한 진행률 표시 (0-100%)
   - 상태 메시지 라벨로 현재 작업 단계 표시
   - 실시간 업데이트를 위한 콜백 함수 구현
   - 처리 단계별 메시지:
     * "PDF 읽기 완료"
     * "페이지 처리 중: X/Y"
     * "메타데이터 설정 중..."
     * "비밀번호 및 권한 설정 중..."
     * "파일 저장 중..."
     * "완료!"

4. **비동기 처리**
   - `threading.Thread`를 사용하여 PDF 처리를 별도 스레드에서 실행
   - GUI 블로킹 방지로 사용자 경험 향상
   - 처리 중 버튼 비활성화로 중복 실행 방지

5. **오류 처리 및 알림**
   - 입력값 검증 실패 시 오류 메시지 박스 표시
   - 처리 완료 시 성공 메시지와 비밀번호 정보 표시
   - 예외 발생 시 상세 오류 메시지 표시

### 2.2 메타데이터 추가 기능

**기능 설명**:
- PDF 파일의 메타데이터에 구매자 정보 추가
- 문서 속성에서 구매자 정보 확인 가능

**구현 세부사항**:
- PDF 표준 메타데이터 키 사용 (`/Title`, `/Author`, `/Subject`, `/Creator`, `/Producer`)
- 제목: "구매자: {이름}"
- 작성자: "{이름}"
- 주제: "구매자 정보: {이름} ({연락처})"
- 기존 메타데이터는 유지하면서 구매자 정보 추가
- `pypdf.PdfWriter.add_metadata()` 메서드 사용

### 2.3 비밀번호 보호 기능

**기능 설명**:
- 생성된 PDF 파일에 비밀번호 설정
- 사용자가 직접 비밀번호를 입력하여 설정

**구현 세부사항**:
- PDF 라이브러리의 encrypt 메서드 사용
- 사용자 비밀번호와 소유자 비밀번호를 동일하게 설정
- 128비트 암호화 사용
- PDF 열람 시 비밀번호 입력 필수
- 참고: pypdf에서는 복사/인쇄 권한 제어가 제한적임

---

## 3. 기술 스택 및 의존성

### 3.1 사용 라이브러리

- **reportlab**: PDF 생성 및 워터마크 레이어 생성
  - `reportlab.pdfgen.canvas`: 워터마크 그래픽 생성
  - `reportlab.lib.pagesizes`: 페이지 크기 상수 (A4)
  - `reportlab.pdfbase.pdfmetrics`: 폰트 메트릭 관리
  - `reportlab.pdfbase.ttfonts.TTFont`: TTF 폰트 등록

- **pypdf**: PDF 읽기/쓰기 및 병합
  - `pypdf.PdfReader`: PDF 파일 읽기
  - `pypdf.PdfWriter`: PDF 파일 쓰기 및 암호화

- **io**: 메모리 내 바이너리 스트림 처리
  - `io.BytesIO`: 워터마크 레이어를 메모리에 임시 저장

- **tkinter**: GUI 인터페이스 (Python 표준 라이브러리)
  - `tkinter.filedialog`: 파일 선택 다이얼로그
  - `tkinter.messagebox`: 알림 및 오류 메시지
  - `tkinter.ttk`: 고급 위젯 (Progressbar)

- **platform**: 운영체제 감지 (Python 표준 라이브러리)
  - `platform.system()`: 운영체제 종류 확인

- **threading**: 비동기 처리 (Python 표준 라이브러리)
  - `threading.Thread`: GUI 블로킹 방지를 위한 별도 스레드

- **os, pathlib**: 파일 경로 처리 (Python 표준 라이브러리)

### 3.2 시스템 요구사항

- Python 3.x
- **Windows**: 맑은고딕 또는 굴림 폰트 (시스템 기본 설치)
- **macOS**: 애플고딕 (시스템 기본 설치) 또는 나눔고딕 (선택 설치)
- tkinter 지원 (대부분의 Python 설치에 포함)

---

## 4. 핵심 로직 상세 설명

### 4.1 워터마크 삽입 프로세스

**단계별 처리 흐름**:

1. **폰트 준비 단계 (크로스 플랫폼)**
   - `platform.system()`으로 운영체제 감지
   - **Windows**: 
     * `C:/Windows/Fonts/malgun.ttf` (맑은고딕) 우선 확인
     * 없으면 `C:/Windows/Fonts/gulim.ttc` (굴림) 확인
   - **macOS**:
     * `/System/Library/Fonts/AppleGothic.ttf` 우선 확인
     * 없으면 `/Library/Fonts/NanumGothic.ttf` 또는 사용자 폰트 디렉토리 확인
   - 각 경로를 순차적으로 확인하여 존재하는 첫 번째 폰트 사용
   - 폰트 등록 성공 시 해당 폰트 이름으로 등록
   - 모든 경로에서 폰트를 찾지 못한 경우 Helvetica 기본 폰트 사용 (한글 깨짐 주의)

2. **워터마크 그래픽 생성 단계**
   - 메모리 내 바이너리 버퍼(BytesIO) 생성
   - A4 크기의 가상 캔버스 생성
   - 캔버스에 다음 속성 설정:
     * 폰트: 등록된 한글 폰트 또는 기본 폰트
     * 폰트 크기: 10pt
     * 색상: RGB(128, 128, 128) - 0~255 스케일을 0~1로 변환한 값
     * 투명도: 60% (Alpha 0.6)
   - 왼쪽 하단 위치에 텍스트 그리기
     * x 좌표: 30 포인트 (왼쪽 여백)
     * y 좌표: 45 포인트 (하단에서 글자 높이의 1.5배만큼 위로)
   - 캔버스를 PDF 형식으로 메모리에 저장

3. **원본 PDF와 병합 단계**
   - 원본 PDF 파일을 읽어서 모든 페이지 로드
   - 워터마크 레이어 PDF를 읽어서 첫 번째 페이지 추출
   - 원본 PDF의 각 페이지를 순회:
     * 페이지 인덱스가 4 이상인 경우 (5번째 페이지부터):
       - 원본 페이지와 워터마크 레이어를 병합
       - 병합된 페이지를 출력 PDF에 추가
     * 페이지 인덱스가 4 미만인 경우 (1~4번째 페이지):
       - 원본 페이지를 그대로 출력 PDF에 추가

4. **메타데이터 설정 단계**
   - 구매자 정보가 제공된 경우:
     * 기존 메타데이터 읽기
     * 구매자 정보로 메타데이터 업데이트 (제목, 작성자, 주제 등)
     * PDF Writer 객체에 메타데이터 추가

5. **비밀번호 설정 단계**
   - 비밀번호가 제공된 경우:
     * PDF Writer 객체에 암호화 설정 적용
     * 사용자 비밀번호와 소유자 비밀번호를 동일하게 설정
     * 128비트 암호화 사용

6. **파일 저장 단계**
   - 처리된 모든 페이지가 포함된 PDF Writer 객체를 바이너리 모드로 파일에 저장
   - 저장 완료 메시지 출력

### 4.2 사용자 입력 처리

**실행 흐름**:
1. 사용자로부터 구매자 이름 입력 받기
2. 사용자로부터 연락처(전화번호 뒷자리 또는 이메일) 입력 받기
3. 사용자로부터 PDF 비밀번호 입력 받기
4. 워터마크 텍스트 생성: "이 책은 {이름} ({연락처}) 님이 구매하신 전자책입니다."
5. 원본 파일명과 출력 파일명 설정
6. 워터마크 삽입, 메타데이터 추가, 비밀번호 설정 함수 호출

---

## 5. 사용 방법

### 5.1 GUI 사용법

1. **스크립트 실행**
   ```bash
   python pdf_secure.py
   ```

2. **파일 선택**
   - "파일 선택" 버튼 클릭
   - 원본 PDF 파일 선택

3. **구매자 정보 입력**
   - 이름 필드에 구매자 이름 입력
   - 연락처 필드에 전화번호 또는 이메일 입력
   - PDF 비밀번호 필드에 원하는 비밀번호 입력
   - 입력 시 하단에 워터마크 문구 미리보기 표시

4. **처리 시작**
   - "처리 시작" 버튼 클릭
   - 진행 상황 바와 상태 메시지로 처리 과정 확인

5. **결과 확인**
   - 처리 완료 시 성공 메시지와 비밀번호 정보 표시
   - 생성된 파일: 원본 파일과 같은 디렉토리에 `{원본파일명}_{구매자명}.pdf` 형식으로 저장
   - 파일 열기 시 비밀번호 입력 필요 (입력한 비밀번호)
   - 문서 속성에서 구매자 정보 확인 가능

### 5.2 주의사항

- **폰트**: Windows와 macOS에서 자동으로 한글 폰트를 찾지만, 폰트가 없는 경우 한글이 깨질 수 있음
- **파일 크기**: 200페이지 내외의 PDF는 처리 시간이 수 초~1분 정도 소요될 수 있음
- **메모리**: 대용량 PDF 처리 시 메모리 사용량이 증가할 수 있음

---

## 6. 향후 추가 예정 기능 (기획)

### 6.1 사용자 인터페이스 개선

**목표**: 명령줄 입력 대신 더 편리한 인터페이스 제공

**기획 내용**:
- [x] GUI 인터페이스 추가 (tkinter)
  - [x] 파일 선택 다이얼로그
  - [x] 구매자 정보 입력 폼
  - [x] 진행 상황 표시
  - [ ] 배치 처리 기능 (여러 구매자 동시 처리) - 현재 불필요 (주간 10건 미만)

- [ ] 웹 인터페이스 (선택사항)
  - Flask/FastAPI 기반 웹 서버
  - 파일 업로드 및 다운로드
  - 구매자 정보 데이터베이스 연동

### 6.2 기능 확장

**목표**: 보안성 및 편의성 향상

**기획 내용**:
- [ ] 워터마크 커스터마이징 옵션
  - 폰트 크기 조절
  - 색상 선택
  - 투명도 조절
  - 위치 선택 (왼쪽/오른쪽/중앙, 상단/하단)
  - 워터마크 시작 페이지 설정

- [ ] 고급 보안 기능
  - QR 코드 워터마크 (구매자 정보 포함)
  - 숨겨진 메타데이터 삽입
  - 디지털 서명 추가
  - 복사/인쇄 제한 옵션

- [ ] 배치 처리 기능
  - CSV/Excel 파일에서 구매자 목록 읽기
  - 여러 PDF 파일 동시 처리
  - 처리 결과 리포트 생성

### 6.3 서버리스 아키텍처 (검토 중)

**목표**: 웹 기반 서비스로 확장

**검토 사항**:
- **사용량**: 주간 10건 미만, PDF 평균 200페이지
- **AWS Lambda 무료 한도**: 월 100만 건, 400,000 GB-초
- **제약사항**: 
  * API Gateway 페이로드 제한 6MB (200페이지 PDF는 보통 10-50MB)
  * S3를 통한 파일 업로드/다운로드 필요
- **결론**: 무료 한도 내에서 충분히 가능하나, S3 스토리지 비용 및 복잡도 고려 필요
- **현재 결정**: 로컬 GUI 우선 구현, 서버리스는 향후 검토

### 6.4 데이터 관리

**목표**: 구매자 정보 체계적 관리

**기획 내용**:
- [ ] 구매자 정보 데이터베이스
  - SQLite 또는 PostgreSQL 연동
  - 구매자 정보 저장 및 조회
  - 처리 이력 관리
  - 중복 구매자 검색

- [ ] 로깅 및 감사 기능
  - 처리 로그 기록
  - 오류 로그 저장
  - 통계 정보 수집 (처리 건수, 오류율 등)

### 6.5 성능 최적화

**목표**: 대용량 파일 및 대량 처리 성능 향상

**기획 내용**:
- [ ] 대용량 PDF 처리 최적화
  - 스트리밍 처리로 메모리 사용량 감소
  - 멀티프로세싱을 통한 병렬 처리

- [ ] 캐싱 기능
  - 폰트 로드 캐싱
  - 워터마크 레이어 재사용

### 6.6 오류 처리 및 검증

**목표**: 안정성 향상

**기획 내용**:
- [ ] 입력 검증 강화
  - 파일 존재 여부 확인
  - PDF 파일 유효성 검증
  - 구매자 정보 형식 검증

- [ ] 오류 복구 기능
  - 처리 실패 시 롤백
  - 부분 실패 시 재시도 로직
  - 상세한 오류 메시지 제공

### 6.7 설정 관리

**목표**: 유연한 설정 관리

**기획 내용**:
- [ ] 설정 파일 지원
  - YAML/JSON 설정 파일
  - 기본값 설정
  - 환경별 설정 (개발/운영)

- [ ] 명령줄 인자 지원
  - argparse를 통한 옵션 처리
  - 설정 파일 경로 지정
  - 배치 모드 실행

---

## 7. 기술 부채 및 개선 사항

### 7.1 현재 제한사항

- pypdf에서 복사/인쇄 권한 제어가 제한적임 (비밀번호 보호만 가능)
- 오류 처리가 기본적인 수준
- 입력 검증이 기본적인 수준 (빈 값 체크만)

### 7.2 개선 우선순위

1. **높음**: 입력 검증 강화 (이메일 형식, 전화번호 형식 등)
2. **중간**: 오류 처리 강화, 복사/인쇄 권한 제어 (PyPDF2 전환 검토)
3. **낮음**: 배치 처리 기능, 워터마크 커스터마이징

---

## 8. 참고 자료

### 8.1 사용 라이브러리 문서

- [ReportLab 공식 문서](https://www.reportlab.com/docs/reportlab-userguide.pdf)
- [pypdf 공식 문서](https://pypdf.readthedocs.io/)

### 8.2 관련 기술

- PDF 표준: ISO 32000
- 폰트 처리: TrueType Font (TTF) 형식

---

## 9. 변경 이력

### v2.0 (현재)
- **크로스 플랫폼 지원**: Windows와 macOS 모두 지원
- **폰트 처리 개선**: 운영체제별 한글 폰트 자동 감지 및 등록
- **GUI 인터페이스**: tkinter 기반 그래픽 사용자 인터페이스 구현
- **파일 선택 다이얼로그**: 원본 PDF 파일 선택 기능
- **구매자 정보 입력 폼**: 이름, 연락처, PDF 비밀번호 입력 인터페이스
- **미리보기 기능**: 이름과 연락처 입력 시 워터마크 문구 실시간 미리보기
- **진행 상황 표시**: 실시간 진행률 및 상태 메시지 표시
- **비동기 처리**: GUI 블로킹 방지를 위한 스레드 처리
- **메타데이터 추가**: PDF 문서 속성에 구매자 정보 추가
- **비밀번호 입력**: 사용자가 직접 PDF 비밀번호 설정

### v1.0
- 워터마크 삽입 기능 구현
- 비밀번호 보호 기능 구현
- 5번째 페이지부터 워터마크 적용
- 왼쪽 하단 워터마크 배치
- 투명도 및 색상 조정 기능

---

## 10. 기여 가이드

새로운 기능 추가 시:
1. 이 문서의 "향후 추가 예정 기능" 섹션에 계획 추가
2. 구현 완료 후 해당 항목을 "현재 구현된 기능"으로 이동
3. 변경 이력에 버전 정보 추가

